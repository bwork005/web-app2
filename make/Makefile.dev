# Development build configuration for Alpine Linux container

CC = gcc
ARCH_FLAGS = -march=native

OPT_FLAGS = -O0 -ggdb3 \
            -fno-omit-frame-pointer \
            -fno-inline

DEBUG_FLAGS = -DDEBUG \
             -DDEV_BUILD \
             -fsanitize=address \
             -fsanitize=undefined

CFLAGS = $(SHARED_FLAGS) \
         $(ARCH_FLAGS) \
         $(OPT_FLAGS) \
         $(DEBUG_FLAGS)

LDFLAGS = -pthread \
          -fsanitize=address \
          -fsanitize=undefined \
          -lssl -lcrypto

# Development paths and users
DEV_PREFIX = /devcontainer/dev
DEV_USER = appuser
DEV_GROUP = appuser
DEV_UID = 1000
DEV_GID = 1000

# Development file paths
DEV_SSL_CERT = $(PREFIX)/etc/ssl/cert.pem
DEV_SSL_KEY = $(PREFIX)/etc/ssl/privkey.pem
DEV_CONFIG = $(PREFIX)/etc/env/.env
DEV_AUTH = $(PREFIX)/etc/auth/passwd
DEV_DB = $(PREFIX)/var/lib/records.rec
DEV_LOG = $(PREFIX)/var/log/app.log
DEV_AUDIT = $(PREFIX)/var/log/audit.log

# Development targets
dev-install: all
    @echo "Installing in development environment..."
    @install -d -m 755 $(DEV_PREFIX)/bin
    @install -d -m 750 $(DEV_PREFIX)/etc/app/ssl
    @install -d -m 750 $(DEV_PREFIX)/etc/app/auth
    @install -d -m 750 $(DEV_PREFIX)/etc/app/env
    @install -d -m 750 $(DEV_PREFIX)/var/log
    @install -d -m 750 $(DEV_PREFIX)/var/lib
    @install -m 755 $(TARGET) $(DEV_PREFIX)/bin/
    @install -m 600 $(SSL_KEY) $(DEV_PREFIX)/etc/app/ssl/
    @install -m 644 $(SSL_CERT) $(DEV_PREFIX)/etc/app/ssl/
    @install -m 600 $(CONFIG_PATH) $(DEV_PREFIX)/etc/app/env/
    @install -m 600 $(AUTH_PATH) $(DEV_PREFIX)/etc/app/auth/
    @install -m 644 $(LOG_PATH) $(DEV_PREFIX)/var/log/
    @install -m 600 $(AUDIT_PATH) $(DEV_PREFIX)/var/log/

dev-setup: dirs
    @echo "Setting up development environment..."
    @install -m 644 config/cert.pem.example $(DEV_SSL_CERT)
    @install -m 600 config/privkey.pem.example $(DEV_SSL_KEY)
    @install -m 600 config/.env.example $(DEV_CONFIG)
    @install -m 600 config/passwd.example $(DEV_AUTH)
    @touch $(DEV_DB)
    @touch $(DEV_LOG)
    @touch $(DEV_AUDIT)

clean-dev:
    @echo "Cleaning development environment..."
    @rm -rf $(DEV_PREFIX)/*
    @rm -rf $(OBJ_DIR)/*
    @rm -rf $(BIN_DIR)/*
